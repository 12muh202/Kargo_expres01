<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –†–µ–π—Å–∞–º–∏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-title { text-align: center; font-size: 2em; color: #2c3e50; margin-bottom: 30px; }
        .login-icon { text-align: center; font-size: 4em; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .btn-login { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .btn-login:hover { background: #5568d3; }
        .error-msg { color: #e74c3c; text-align: center; margin-top: 15px; font-weight: 600; }
        .success-msg { color: #27ae60; text-align: center; margin-top: 15px; font-weight: 600; }
        .loading { text-align: center; padding: 20px; color: #667eea; font-size: 1.2em; }
        
        .container { max-width: 2400px; margin: 0 auto; padding: 20px; }
        .header { background: white; border-radius: 20px; padding: 20px 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header-left h1 { color: #2c3e50; font-size: 1.8em; margin-bottom: 5px; }
        .header-left p { color: #7f8c8d; }
        .header-right { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .user-email { font-weight: 600; color: #2c3e50; }
        .firebase-status { padding: 8px 15px; border-radius: 20px; font-weight: 600; font-size: 0.9em; background: #d4edda; color: #155724; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-logout { background: #e74c3c; color: white; }
        .btn-download { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-delete { background: #c0392b; color: white; padding: 8px 15px; font-size: 0.9em; }
        .btn-print-invoice { background: #3498db; color: white; padding: 8px 15px; font-size: 0.95em; }
        .btn-share { background: #25D366; color: white; padding: 10px 20px; font-size: 0.95em; }
        .btn-telegram { background: #0088cc; color: white; padding: 10px 20px; font-size: 0.95em; }
        
        .tabs { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; }
        .tab { padding: 12px 30px; border: none; border-radius: 10px; font-weight: 700; font-size: 1em; cursor: pointer; background: #f0f0f0; color: #666; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover:not(.active) { background: #e0e0e0; }
        
        .upload-section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa; }
        .upload-area:hover { background: #e9ecef; border-color: #764ba2; }
        .upload-icon { font-size: 4em; margin-bottom: 15px; }
        
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .order-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; transition: all 0.3s ease; }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.25); }
        .order-card-content { cursor: pointer; }
        .order-icon { font-size: 3em; text-align: center; margin-bottom: 10px; }
        .order-title { font-size: 1.1em; font-weight: 700; color: #2c3e50; margin-bottom: 8px; text-align: center; }
        .order-info { color: #7f8c8d; font-size: 0.9em; text-align: center; margin-bottom: 5px; }
        .order-actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        
        .database-section { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow-x: auto; margin-bottom: 20px; }
        .database-table { width: 100%; border-collapse: collapse; min-width: 1800px; }
        .database-table th { background: #4a4a4a; color: white; padding: 16px; text-align: center; font-weight: 700; border: 1px solid #000; font-size: 15px; height: 50px; }
        .database-table td { padding: 14px; border: 1px solid #000; font-weight: 600; font-size: 15px; position: relative; height: 55px; }
        .database-table tbody tr:hover { background: #f0f0f0; }
        .editable-cell { cursor: pointer; transition: all 0.2s; }
        .editable-cell:hover { background: #fff3cd !important; }
        .cell-input { width: 100%; border: 2px solid #667eea; padding: 10px; font-size: 15px; font-weight: 600; box-sizing: border-box; }
        .cell-input:focus { outline: none; border-color: #764ba2; }
        
        .som-column { background: #fff8dc !important; font-weight: bold; }
        
        .status-cell { text-align: center; cursor: pointer; font-weight: bold; }
        .status-unpaid { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; }
        
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .filter-btn.active { background: #667eea; color: white; }
        .filter-btn:not(.active) { background: #f0f0f0; color: #666; }
        .filter-btn:hover:not(.active) { background: #e0e0e0; }
        
        .table-filters { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .search-input { padding: 10px 15px; border: 2px solid #667eea; border-radius: 10px; font-size: 0.95em; min-width: 250px; }
        .search-input:focus { outline: none; border-color: #764ba2; }
        
        .date-filter { padding: 10px 15px; border: 2px solid #667eea; border-radius: 10px; font-size: 0.95em; font-weight: 600; }
        
        .totals-summary { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .totals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .total-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .total-card-label { color: #7f8c8d; font-size: 0.9em; margin-bottom: 8px; }
        .total-card-value { font-size: 2em; font-weight: bold; }
        .total-all { color: #2c3e50; }
        .total-paid { color: #27ae60; }
        .total-unpaid { color: #e74c3c; }
        .total-som { color: #f39c12; }
        .employee-debts { margin-top: 15px; }
        .employee-debt-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .employee-name { font-weight: bold; color: #2c3e50; }
        .employee-debt { font-size: 1.2em; font-weight: bold; color: #e74c3c; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 98%; width: 100%; max-height: 95vh; overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
        .modal-close { position: fixed; top: 30px; right: 30px; font-size: 3em; cursor: pointer; color: white; background: #e74c3c; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .modal-close:hover { transform: rotate(90deg) scale(1.1); }
        .modal-title { font-size: 1.8em; font-weight: 700; color: #2c3e50; margin-bottom: 20px; text-align: center; }
        
        .hidden { display: none !important; }

        .invoice-print-area { display: none; }
        
        .total-row {
            background: #fffacd !important;
            font-weight: bold;
            font-size: 16px;
        }
        
        .total-row td {
            background: #fffacd !important;
            border: 2px solid #000 !important;
            padding: 16px !important;
            height: 60px !important;
        }
        
        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        @media print {
            body * { visibility: hidden; }
            
            .invoice-print-area, .invoice-print-area * { 
                visibility: visible; 
            }
            
            .invoice-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }
            
            .invoice-print-area:empty {
                display: none !important;
            }
            
            .print-invoice {
                page-break-inside: avoid;
                margin-bottom: 5mm;
                height: 50vh;
            }
            
            .print-invoice-header {
                text-align: center;
                font-size: 20px;
                font-weight: bold;
                padding: 15px;
                border: 3px solid #000;
                margin-bottom: 10px;
            }
            
            .print-invoice-table {
                width: 100%;
                border-collapse: collapse;
                border: 3px solid #000;
                margin-bottom: 10px;
            }
            
            .print-invoice-table th,
            .print-invoice-table td {
                border: 2px solid #000;
                padding: 12px;
                text-align: center;
                font-size: 15px;
            }
            
            .print-invoice-table th {
                background: #f0f0f0;
                font-weight: bold;
                height: 40px;
            }
            
            .print-invoice-table tbody tr {
                height: 45px;
            }
            
            .print-invoice-footer {
                display: flex;
                justify-content: space-between;
                margin-top: 15px;
                padding: 15px;
                border: 3px solid #000;
                font-size: 14px;
            }
        }
        
        @media print {
            body:not(:has(.invoice-print-area:not(:empty))) * {
                visibility: visible !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .header,
            body:not(:has(.invoice-print-area:not(:empty))) .tabs,
            body:not(:has(.invoice-print-area:not(:empty))) .filters,
            body:not(:has(.invoice-print-area:not(:empty))) .table-filters,
            body:not(:has(.invoice-print-area:not(:empty))) .totals-summary,
            body:not(:has(.invoice-print-area:not(:empty))) .btn,
            body:not(:has(.invoice-print-area:not(:empty))) button {
                display: none !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .database-section {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .modal-content {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .database-table {
                table-layout: fixed !important;
                width: 100% !important;
                font-size: 13px !important;
                border-collapse: collapse !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .database-table th,
            body:not(:has(.invoice-print-area:not(:empty))) .database-table td {
                width: calc(95% / 25) !important;
                padding: 0px !important;
                font-size: 13px !important;
                line-height: 1 !important;
                overflow: hidden !important;
                text-overflow: clip !important;
                white-space: nowrap !important;
                border: 2px solid #000000 !important;
                text-align: center!important;
                vertical-align: middle!important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .employee-select,
            body:not(:has(.invoice-print-area:not(:empty))) .cell-input {
                border: none !important;
                padding: 0 !important;
                font-size: 13px !important;
            }
        }
        
        body:not(:has(.invoice-print-area:not(:empty))) .database-section {
            transform: scale(0.90);
            transform-origin: top left;
            width: 117%;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .voice-notification {
            position: fixed;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            transition: opacity 0.3s;
        }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .tabs { flex-direction: column; }
            .orders-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-page">
        <div class="login-box">
            <div class="login-icon">üîê</div>
            <div class="login-title" id="authTitle">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</div>
            
            <div id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="example@gmail.com">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn-login" onclick="login()">–í–æ–π—Ç–∏</button>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showRegisterForm(); return false;" style="color: #667eea; text-decoration: none; font-weight: 600;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="example@gmail.com">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPassword" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                </div>
                <div class="input-group">
                    <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn-login" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showLoginForm(); return false;" style="color: #667eea; text-decoration: none; font-weight: 600;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
                </div>
            </div>
            
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>

    <div id="mainPage" class="hidden">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <h1> –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –†–µ–π—Å–∞–º–∏</h1>
                    <p> —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</p>
                </div>
                <div class="header-right">
                    <div class="firebase-status">–ë–∞–∑–∞ –¥–∞–Ω—ã–π  –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
                    <div class="user-email" id="userEmail"></div>
                    <button class="btn btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('main')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
                <button class="tab" onclick="switchTab('database')">üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="tab hidden" id="adminTabBtn" onclick="switchTab('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</button>
            </div>

            <div id="mainTab">
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #2c3e50;">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã</div>
                        <div style="color: #7f8c8d; margin-top: 10px;">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ —Å—Ä–∞–∑—É</div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" multiple style="display: none;">
                    </div>
                </div>

                <div class="totals-summary" id="mainTotalsSummary"></div>

                <div class="filters">
                    <button class="btn btn-success" onclick="startVoiceSearch('main')" style="font-size: 1.1em;">üé§ –ì–æ–ª–æ—Å</button>
                    <button class="filter-btn active" onclick="setMainFilter('all')">üìã –í—Å–µ —Ä–µ–π—Å—ã</button>
                    <button class="filter-btn" onclick="setMainFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button class="filter-btn" onclick="setMainFilter('unpaid')">‚ùå –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button class="btn btn-download" onclick="downloadAllOrders()" style="margin-left: auto;">üíæ Excel</button>
                    <button class="btn btn-success" onclick="shareFilteredData('whatsapp')">üì± WhatsApp</button>
                    <button class="btn btn-telegram" onclick="shareFilteredData('telegram')">üì± Telegram</button>
                    <button class="btn btn-download" onclick="printMain()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                </div>

                <div class="orders-grid" id="ordersGrid"></div>
            </div>

            <div id="databaseTab" class="hidden">
                <div class="totals-summary" id="totalsSummary"></div>
                
                <div class="filters">
                    <button class="btn btn-success" onclick="startVoiceSearch('database')" style="font-size: 1.1em;">üé§ –ì–æ–ª–æ—Å</button>
                    <button class="filter-btn active" onclick="setFilter('all')">üìã –í—Å–µ</button>
                    <button class="filter-btn" onclick="setFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>
                    <button class="filter-btn" onclick="setFilter('unpaid')">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</button>
                    <select id="employeeFilter" onchange="filterByEmployee()" style="padding: 10px; border-radius: 10px; font-weight: 600; border: 2px solid #667eea; margin-left: 10px;">
                        <option value="">üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                    </select>
                    <input type="date" id="dateFilterFrom" class="date-filter" onchange="filterByDate()" placeholder="–° –¥–∞—Ç—ã">
                    <input type="date" id="dateFilterTo" class="date-filter" onchange="filterByDate()" placeholder="–î–æ –¥–∞—Ç—ã">
                    <button class="btn btn-success" onclick="clearDateFilter()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å –¥–∞—Ç—ã</button>
                    <button class="btn btn-download" onclick="downloadDatabase()" style="margin-left: auto;">üíæ Excel</button>
                    <button class="btn btn-success" onclick="shareFilteredData('whatsapp')">üì± WhatsApp</button>
                    <button class="btn btn-telegram" onclick="shareFilteredData('telegram')">üì± Telegram</button>
                    <button class="btn btn-download" onclick="printDatabase()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                </div>
                
                <div class="database-section">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üìä –í—Å–µ —Ä–µ–π—Å—ã –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ</h2>
                    <div class="table-filters">
                        <input type="text" id="dbSearchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ..." oninput="filterDatabaseTable()">
                        <button class="btn btn-success" onclick="clearDatabaseSearch()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="database-table" id="databaseTable">
                            <thead id="databaseTableHead"></thead>
                            <tbody id="databaseTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="adminTab" class="hidden">
                <div class="database-section" style="margin-bottom: 20px;">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üí± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—É—Ä—Å–∞</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap;">
                        <label style="font-weight: 600; font-size: 1.1em;">–ö—É—Ä—Å USD ‚Üí KGZ:</label>
                        <input type="number" id="kgzRateInput" step="0.1" 
                               style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 1.1em; font-weight: 600; width: 150px;"
                               onchange="updateKgzRate(this.value)">
                        <span style="color: #7f8c8d;">—Å–æ–º</span>
                    </div>
                </div>
                
                <div class="database-section">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="email" id="newUserEmail" placeholder="Email" style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #667eea; border-radius: 8px;">
                            <input type="password" id="newUserPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #667eea; border-radius: 8px;">
                            <button class="btn btn-success" onclick="addNewUser()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                        </div>
                        <div id="addUserMessage" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #856404;">üîß –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-danger" onclick="cleanupDuplicates()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–µ–π—Å–æ–≤</button>
                            <span style="color: #856404; font-size: 0.9em;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –∏ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Ä–µ–π—Å—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</span>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="database-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>–ü–∞—Ä–æ–ª—å</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="database-section">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h2>
                    <div id="userStatsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <span class="modal-close" id="modalClose">√ó</span>
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            
            <div id="modalTotalsSummary" class="totals-summary"></div>
            
            <div style="text-align: center; margin-bottom: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="startVoiceSearch('modal')" style="font-size: 1.1em;">üé§ –ì–æ–ª–æ—Å</button>
                <button class="btn btn-download" onclick="downloadCurrentOrder('unpaid')">üíæ Excel –Ω–µ–æ–ø–ª–∞—á.</button>
                <button class="btn btn-download" onclick="downloadCurrentOrder('all')">üíæ Excel –≤—Å–µ</button>
                <button class="filter-btn active" onclick="setModalFilter('all')">üìã –í—Å–µ</button>
                <button class="filter-btn" onclick="setModalFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>
                <button class="filter-btn" onclick="setModalFilter('unpaid')">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</button>
                <div class="share-buttons">
                    <button class="btn btn-success" onclick="shareModalData('whatsapp')">üì± WhatsApp</button>
                    <button class="btn btn-telegram" onclick="shareModalData('telegram')">üì± Telegram</button>
                </div>
                <button class="btn btn-download" onclick="printModal()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            </div>
            <div class="table-filters">
                <input type="text" id="modalSearchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ..." oninput="filterModalTable()">
                <button class="btn btn-success" onclick="clearModalSearch()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div id="tableWrapper"></div>
        </div>
    </div>

    <div class="invoice-print-area" id="invoicePrintArea"></div>

    <script>

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCkefQU7Jt8-yhXJCR7l2eSxDQFGjMVLb4",
  authDomain: "kargo-program-7fa29.firebaseapp.com",
  projectId: "kargo-program-7fa29",
  storageBucket: "kargo-program-7fa29.firebasestorage.app",
  messagingSenderId: "717073047804",
  appId: "1:717073047804:web:1d012598daf84e5fd7f779",
  measurementId: "G-SP7ZEVLJJ3"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let orders = [];
let currentOrder = null;
let currentTab = 'main';
let currentFilter = 'all';
let mainFilter = 'all';
let modalFilter = 'all';
let employeeFilter = '';
let dateFilterFrom = '';
let dateFilterTo = '';

// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø BATCH –°–û–•–†–ê–ù–ï–ù–ò–Ø
let isSaving = false;  // –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
let savingProgress = { current: 0, total: 0 };  // –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

// –ó–ê–©–ò–¢–ê –û–¢ –ó–ê–ö–†–´–¢–ò–Ø –°–¢–†–ê–ù–ò–¶–´ –í–û –í–†–ï–ú–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø
window.addEventListener('beforeunload', function(e) {
    if (isSaving) {
        e.preventDefault();
        e.returnValue = '–ò–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
        return '–ò–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
    }
});

const ADMIN_EMAIL = '12abc202@gmail.com';
const ADMIN_PASSWORD = 'Abu_1610';
const EMPLOYEES = ['–ú—É—Ö–∞–º–º–∞–¥ –ê–º–∏–Ω', '–ê–Ω–≤–∞—Ä', '–ñ–æ–ª–¥–∏–≤–æ–π', '–°–∏—Ä–æ–∂', '–ù–∏–∞–∑', '–ê–≤–∞–∑–±–µ–∫', '–ê–±–¥—É–º–∞–ª–∏–∫', '–ú—É–∑–∞—Ñ—Ñ–∞—Ä', '–§–∞—Ä—É—Ö', '–ì–∞–π—Ä–∞—Ç', '–ù—É—Ä–∏–¥–∏–Ω', '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä','–ê–±–¥—É–ª–ª–æ','–û–º–∞—Ç','–û—Ç–∞–±–µ–∫','–ú—É—Ä–æ–¥–∏–ª','–ê–±–¥—É—Å–∞–π–∏—Ç','–ê–±—É–±–∞–∫–∏—Ä'];

// Storage functions
async function getFromStorage(key) {
    try {
        const doc = await db.collection('settings').doc(key).get();
        if (doc.exists) {
            return doc.data().value;
        }
        return null;
    } catch (error) {
        console.log('Key not found:', key);
        return null;
    }
}

function cleanData(value) {
    if (value === undefined || value === null) {
        return null;
    }
    if (typeof value === 'object' && !Array.isArray(value)) {
        const cleaned = {};
        for (const key in value) {
            if (value.hasOwnProperty(key) && value[key] !== undefined) {
                cleaned[key] = cleanData(value[key]);
            }
        }
        return cleaned;
    }
    if (Array.isArray(value)) {
        return value.map(item => cleanData(item)).filter(item => item !== undefined);
    }
    return value;
}

async function setToStorage(key, value) {
    try {
        const cleanedValue = cleanData(value);
        await db.collection('settings').doc(key).set({ value: cleanedValue });
        return true;
    } catch (error) {
        console.error('Storage error:', error);
        return false;
    }
}

function getKgzRate() {
    const rate = localStorage.getItem('kgz_rate');
    if (!rate) {
        localStorage.setItem('kgz_rate', '88.5');
        return 88.5;
    }
    return parseFloat(rate);
}

function setKgzRate(rate) {
    localStorage.setItem('kgz_rate', rate.toString());
}

function calculateSom(sumDollar, yulKira) {
    const total = (parseFloat(sumDollar) || 0) + (parseFloat(yulKira) || 0);
    return Math.round(total * getKgzRate());
}

function extractFlightNumber(fileName) {
    const match = fileName.match(/(\d+)/);
    return match ? parseInt(match[1]) : 999999;
}

function sortOrdersByFlightNumber() {
    orders.sort((a, b) => {
        const numA = extractFlightNumber(a.fileName);
        const numB = extractFlightNumber(b.fileName);
        return numA - numB;
    });
}

async function init() {
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            await initializeUsers();
            showMainPage();
        } else {
            showLoginPage();
        }
    });
    populateEmployeeFilter();
}

function populateEmployeeFilter() {
    const select = document.getElementById('employeeFilter');
    EMPLOYEES.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp;
        option.textContent = emp;
        select.appendChild(option);
    });
}

async function initializeUsers() {
    const users = await getFromStorage('users');
    if (!users) {
        const defaultUsers = [
            { email: ADMIN_EMAIL, password: ADMIN_PASSWORD, isAdmin: true }
        ];
        await setToStorage('users', defaultUsers);
    }
}

async function cleanupDuplicates() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–µ–π—Å–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.')) {
        return;
    }
    
    try {
        const snapshot = await db.collection('orders').get();
        
        const ordersByKey = new Map();
        const duplicatesToDelete = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            const key = `${data.fileName}_${data.userEmail}`;
            
            if (ordersByKey.has(key)) {
                const existing = ordersByKey.get(key);
                const existingDate = new Date(existing.data.uploadDate || 0);
                const currentDate = new Date(data.uploadDate || 0);
                const existingDataCount = existing.data.data ? existing.data.data.length : 0;
                const currentDataCount = data.data ? data.data.length : 0;
                
                if (currentDataCount > existingDataCount || 
                    (currentDataCount === existingDataCount && currentDate > existingDate)) {
                    duplicatesToDelete.push(existing.id);
                    ordersByKey.set(key, { id: doc.id, data });
                } else {
                    duplicatesToDelete.push(doc.id);
                }
            } else {
                ordersByKey.set(key, { id: doc.id, data });
            }
        });
        
        if (duplicatesToDelete.length > 0) {
            const batch = db.batch();
            duplicatesToDelete.forEach(id => {
                batch.delete(db.collection('orders').doc(id));
            });
            await batch.commit();
            alert(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${duplicatesToDelete.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.`);
            await loadUserOrders();
        } else {
            alert('‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.');
    }
}

function showLoginPage() {
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('mainPage').classList.add('hidden');
    showLoginForm();
}

function showLoginForm() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
    document.getElementById('authTitle').textContent = '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É';
    document.getElementById('loginError').textContent = '';
}

function showRegisterForm() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
    document.getElementById('authTitle').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
    document.getElementById('loginError').textContent = '';
}

async function showMainPage() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('userEmail').textContent = currentUser.email;
    
    orders = [];
    
    const users = await getFromStorage('users') || [];
    const user = users.find(u => u.email === currentUser.email);
    
    const adminTabBtn = document.getElementById('adminTabBtn');
    if (user && user.isAdmin) {
        adminTabBtn.classList.remove('hidden');
        document.getElementById('kgzRateInput').value = getKgzRate();
    } else {
        adminTabBtn.classList.add('hidden');
    }
    
    await loadUserOrders();
}

async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorMsg = document.getElementById('loginError');

    if (!email || !password) {
        errorMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        errorMsg.className = 'error-msg';
        return;
    }

    try {
        const users = await getFromStorage('users') || [];
        const user = users.find(u => u.email === email && u.password === password);

        if (user) {
            await auth.signInWithEmailAndPassword(email, password).catch(async (error) => {
                if (error.code === 'auth/user-not-found') {
                    await auth.createUserWithEmailAndPassword(email, password);
                }
            });
        } else {
            errorMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
            errorMsg.className = 'error-msg';
        }
    } catch (error) {
        errorMsg.textContent = '‚ùå ' + error.message;
        errorMsg.className = 'error-msg';
    }
}

async function register() {
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const errorMsg = document.getElementById('loginError');

    if (!email || !password || !passwordConfirm) {
        errorMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        errorMsg.className = 'error-msg';
        return;
    }

    if (password !== passwordConfirm) {
        errorMsg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        errorMsg.className = 'error-msg';
        return;
    }

    if (password.length < 6) {
        errorMsg.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
        errorMsg.className = 'error-msg';
        return;
    }

    try {
        const users = await getFromStorage('users') || [];
        
        if (users.find(u => u.email === email)) {
            errorMsg.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
            errorMsg.className = 'error-msg';
            return;
        }

        users.push({ email, password, isAdmin: false });
        await setToStorage('users', users);

        await auth.createUserWithEmailAndPassword(email, password);

        errorMsg.textContent = '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!';
        errorMsg.className = 'success-msg';
    } catch (error) {
        errorMsg.textContent = '‚ùå ' + error.message;
        errorMsg.className = 'error-msg';
    }
}

function logout() {
    auth.signOut();
    orders = [];
}

async function loadUserOrders() {
    try {
        const snapshot = await db.collection('orders')
            .where('userEmail', '==', currentUser.email)
            .get();
        
        orders = [];
        snapshot.forEach(doc => {
            orders.push({ id: doc.id, ...doc.data() });
        });
        
        sortOrdersByFlightNumber();
        renderAll();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
    }
}






// –î–û–ë–ê–í–¨–¢–ï –í –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê
const calculationCache = new Map();

async function saveOrder(order) {
    try {
        const cleanedOrder = cleanData(order);
        cleanedOrder.lastModified = Date.now();

        const orderId = order.id || db.collection('orders').doc().id;
        cleanedOrder.id = orderId;

        // –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –õ–û–ö–ê–õ–¨–ù–û–ì–û –ö–≠–®–ê
        const idx = orders.findIndex(o => o.id === orderId);
        if (idx >= 0) {
            orders[idx] = cleanedOrder;
        } else {
            orders.push(cleanedOrder);
        }

        // –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–ê–ó–£ –ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø (fire-and-forget)
        db.collection('orders').doc(orderId).set(cleanedOrder)
            .then(() => {
                console.log("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:", cleanedOrder.fileName);
            })
            .catch(error => {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
            });

        // –ò–ù–ö–†–ï–ú–ï–ù–¢–ê–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
        updateOrderInUI(cleanedOrder);
        
        return true;

    } catch (error) {
        console.error("Save error:", error);
        return false;
    }
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –≤ UI
function updateOrderInUI(order) {
    // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–π—Å–∞ –ø–æ ID
    const cards = document.querySelectorAll('.order-card');
    cards.forEach(card => {
        if (card.dataset.orderId === order.id) {
            updateCardContent(card, order);
        }
    });
    
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    if (currentTab === 'database') {
        updateRowsInDatabase(order);
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —Ä–∞—Å—á–µ—Ç–æ–≤
    calculationCache.clear();
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò –ë–ï–ó –ü–ï–†–ï–†–ò–°–û–í–ö–ò –í–°–ï–ì–û GRID
function updateCardContent(cardElement, order) {
    const dataRows = order.data.filter((r, i) => i > 0);
    const paidCount = dataRows.filter(r => r.status === '–æ–ø–ª–∞—á–µ–Ω–æ').length;
    const unpaidCount = dataRows.length - paidCount;
    
    const title = cardElement.querySelector('.order-title');
    const paidInfo = cardElement.querySelector('.order-info:nth-child(5)');
    const unpaidInfo = cardElement.querySelector('.order-info:nth-child(6)');
    
    if (title) title.textContent = formatFlightName(order.fileName);
    if (paidInfo) paidInfo.textContent = `‚úÖ ${paidCount}`;
    if (unpaidInfo) unpaidInfo.textContent = `‚ùå ${unpaidCount}`;
}


// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø BATCH –°–û–•–†–ê–ù–ï–ù–ò–Ø
async function saveOrdersBatch(ordersToSave) {
    const scrollPos = saveScrollPosition();
    if (!ordersToSave || ordersToSave.length === 0) return true;

    isSaving = true;
    savingProgress = { current: 0, total: ordersToSave.length 
        
    };

    try {
        // Firebase –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–∞–∫—Å–∏–º—É–º 500 –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –æ–¥–Ω–æ–º batch
        const MAX_BATCH_SIZE = 500;
        const batches = [];
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
        showSavingProgress(0, ordersToSave.length);
        
        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–∞—Ç—á–∏ –µ—Å–ª–∏ –±–æ–ª—å—à–µ 500 –æ–ø–µ—Ä–∞—Ü–∏–π
        for (let i = 0; i < ordersToSave.length; i += MAX_BATCH_SIZE) {
            const batchOrders = ordersToSave.slice(i, Math.min(i + MAX_BATCH_SIZE, ordersToSave.length));
            const batch = db.batch();
            
            for (const order of batchOrders) {
                const cleanedOrder = cleanData(order);
                cleanedOrder.lastModified = Date.now();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                const snapshot = await db.collection('orders')
                    .where('fileName', '==', cleanedOrder.fileName)
                    .where('userEmail', '==', cleanedOrder.userEmail)
                    .limit(1)
                    .get();
                
                let docId;
                if (!snapshot.empty) {
                    docId = snapshot.docs[0].id;
                } else {
                    docId = db.collection('orders').doc().id;
                }
                
                cleanedOrder.id = docId;
                const docRef = db.collection('orders').doc(docId);
                batch.set(docRef, cleanedOrder);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤
                const idx = orders.findIndex(o => o.id === docId);
                if (idx >= 0) orders[idx] = cleanedOrder;
                else orders.push(cleanedOrder);
            }
            
            batches.push(batch);
        }

        // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –±–∞—Ç—á–∏ —Å –ø–æ–∫–∞–∑–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        let completedCount = 0;
        for (const batch of batches) {
            await batch.commit();
            completedCount += MAX_BATCH_SIZE;
            showSavingProgress(Math.min(completedCount, ordersToSave.length), ordersToSave.length);
        }

        showNotification(`‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${ordersToSave.length} –∑–∞–ø–∏—Å–µ–π!`, "#27ae60");
        renderAll();
        return true;

    } catch (error) {
        console.error("Batch save error:", error);
        showNotification(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏! ${error.message}`, "#e74c3c");
        return false;
    } finally {
        isSaving = false;
        savingProgress = { current: 0, total: 0 };
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function showSavingProgress(current, total) {
    const message = total > 1 
        ? `üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ${current}/${total}...` 
        : 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    showNotification(message, '#3498db');
}

// –§–£–ù–ö–¶–ò–Ø –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –°–û–•–†–ê–ù–ï–ù–ò–Ø
async function saveImmediately(order) {
    if (!order || !order.id) return;
    
    try {
        const cleanedOrder = cleanData(order);
        cleanedOrder.lastModified = Date.now();
        
        await db.collection('orders').doc(order.id).set(cleanedOrder, { merge: true });
        console.log("‚úÖ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:", order.id);
        return true;
    } catch (error) {
        console.error("–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:", error);
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
        return false;
    }
}

// –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ö–û–ù–ö–†–ï–¢–ù–û–ô –Ø–ß–ï–ô–ö–ò
async function saveCellChanges(orderId, rowId, column, newValue) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;
    
    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (column === 'employee') {
        row.employee = newValue;
    } else if (column === 'status') {
        row.status = newValue;
        if (newValue === '–æ–ø–ª–∞—á–µ–Ω–æ') {
            const now = new Date();
            row.paymentDate = now.toLocaleString('ru-RU', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        } else {
            row.paymentDate = null;
        }
    } else if (typeof column === 'number') {
        row.data[column] = newValue;
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –∫–≥ –∏–ª–∏ —Ü–µ–Ω—É
        if (column === 9 || column === 10) {
            const kg = parseFloat(row.data[9]) || 0;
            const price = parseFloat(row.data[10]) || 0;
            row.data[11] = (kg * price).toFixed(2);
        }
    }
    
    // –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
    await saveImmediately(order);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    if (currentTab === 'database') {
        updateRowInDatabaseTable(orderId, rowId);
    }
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
    calculationCache.clear();
    calculateTotals();
    calculateMainTotals();
}

// –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–†–û–ö–ò –í –¢–ê–ë–õ–ò–¶–ï –ë–ï–ó –ü–ï–†–ï–†–ò–°–û–í–ö–ò
function updateRowInDatabaseTable(orderId, rowId) {
    const rowElement = document.getElementById(`row-${orderId}-${rowId}`);
    if (!rowElement) return;
    
    const order = orders.find(o => o.id == orderId);
    if (!order) return;
    
    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏
    const cells = rowElement.cells;
    
    // –Ø—á–µ–π–∫–∞ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º (15-—è —è—á–µ–π–∫–∞)
    const employeeCell = cells[15];
    if (employeeCell) {
        const select = employeeCell.querySelector('select');
        if (select) {
            select.value = row.employee || '';
        }
    }
    
    // –Ø—á–µ–π–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (16-—è —è—á–µ–π–∫–∞)
    const statusCell = cells[16];
    if (statusCell) {
        if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
            statusCell.className = 'status-cell status-paid';
            statusCell.textContent = '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ';
        } else {
            statusCell.className = 'status-cell status-unpaid';
            statusCell.textContent = '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
        }
    }
    
    // –Ø—á–µ–π–∫–∞ –¥–∞—Ç—ã –æ–ø–ª–∞—Ç—ã (17-—è —è—á–µ–π–∫–∞)
    const dateCell = cells[17];
    if (dateCell) {
        dateCell.textContent = row.paymentDate || '-';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –∏ —Å–æ–º –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ
    const sumDollar = parseFloat(row.data[11]) || 0;
    const yulKira = parseFloat(row.data[12]) || 0;
    const som = calculateSom(sumDollar, yulKira);
    
    // –Ø—á–µ–π–∫–∞ —Å—É–º–º—ã (12-—è —è—á–µ–π–∫–∞)
    const sumCell = cells[12];
    if (sumCell) {
        sumCell.textContent = sumDollar.toFixed(2);
    }
    
    // –Ø—á–µ–π–∫–∞ —Å–æ–º–∞ (14-—è —è—á–µ–π–∫–∞)
    const somCell = cells[14];
    if (somCell) {
        somCell.textContent = som.toLocaleString();
    }
}


async function deleteOrderFromDB(orderId) {
    try {
        await db.collection('orders').doc(orderId).delete();
        return true;
    } catch (error) {
        console.error('Delete error:', error);
        return false;
    }
}

function switchTab(tab) {
    currentTab = tab;
    
    // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    // –ü—Ä—è—á–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.getElementById('mainTab').classList.add('hidden');
    document.getElementById('databaseTab').classList.add('hidden');
    document.getElementById('adminTab').classList.add('hidden');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É –ë–ï–ó —Ä–µ–Ω–¥–µ—Ä–∞
    if (tab === 'main') {
        document.getElementById('mainTab').classList.remove('hidden');
        // –ù–ï —Ä–µ–Ω–¥–µ—Ä–∏–º –∑–∞–Ω–æ–≤–æ –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
    } else if (tab === 'database') {
        document.getElementById('databaseTab').classList.remove('hidden');
        // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è
        const tbody = document.getElementById('databaseTableBody');
        if (!tbody.children.length || tbody.children.length === 0) {
            renderDatabase();
        }
    } else if (tab === 'admin') {
        document.getElementById('adminTab').classList.remove('hidden');
        renderAdminPanel();
    }
    
    // –ù–ï –í–´–ó–´–í–ê–ï–ú renderAll() - —ç—Ç–æ —Ç–æ—Ä–º–æ–∑–∏—Ç!
}
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const modal = document.getElementById('modal');
const modalClose = document.getElementById('modalClose');

uploadArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFiles);

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.background = '#667eea';
    uploadArea.style.color = 'white';
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.background = '#f8f9fa';
    uploadArea.style.color = '';
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.background = '#f8f9fa';
    uploadArea.style.color = '';
    handleFiles({ target: { files: e.dataTransfer.files } });
});

modalClose.addEventListener('click', () => modal.classList.remove('active'));
modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.classList.remove('active');
});

async function handleFiles(e) {
    const files = Array.from(e.target.files);
    
    for (const file of files) {
        try {
            const existingOrder = orders.find(o => o.fileName === file.name && o.userEmail === currentUser.email);
            
            let savedStatuses = new Map();
            if (existingOrder) {
                existingOrder.data.forEach((row, idx) => {
                    if (idx > 0 && row.data) {
                        const fio = (row.data[1] || '').trim();
                        if (fio) {
                            savedStatuses.set(fio, {
                                status: row.status || '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ',
                                paymentDate: row.paymentDate || null,
                                employee: row.employee || ''
                            });
                        }
                    }
                });
                
                if (!confirm(`–§–∞–π–ª "${file.name}" —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?\n\n‚úÖ –°—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!`)) {
                    continue;
                }
                
                await deleteOrderFromDB(existingOrder.id);
                orders = orders.filter(o => o.id !== existingOrder.id);
            }
            
            const data = await readFileAsArrayBuffer(file);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '', raw: false });

            const rowsWithStatus = jsonData.map((row, index) => {
                if (index === 0) {
                    return { data: row };
                } else {
                    const fio = (row[1] || '').trim();
                    const phone = (row[4] || '').trim();
                    const key = fio + '|' + phone;
                    const savedData = savedStatuses.get(key);
                    
                    if (savedData) {
                        return {
                            data: row,
                            status: savedData.status,
                            paymentDate: savedData.paymentDate,
                            employee: savedData.employee,
                            rowId: index
                        };
                    } else {
                        return {
                            data: row,
                            status: '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ',
                            paymentDate: null,
                            employee: '',
                            rowId: index
                        };
                    }
                }
            });

            const order = {
                fileName: file.name,
                data: rowsWithStatus.map(row => ({
                    ...row,
                    data: row.data ? row.data.map(cell => cell !== undefined ? cell : '') : []
                })),
                uploadDate: new Date().toLocaleDateString('ru-RU'),
                userEmail: currentUser.email
            };

            await saveOrder(order);
            
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + file.name);
        }
    }
    
    await loadUserOrders();
    
    fileInput.value = '';
    sortOrdersByFlightNumber();
    renderAll();
}

function formatFlightName(fileName) {
    if (!fileName) return '';
    let name = fileName.replace(/\.(xlsx|xls|csv)$/i, '');
    name = name.replace(/^[Ff]-?/g, '');
    return name;
}

function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(new Uint8Array(e.target.result));
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

async function deleteOrder(orderId, event) {
    if (event) {
        event.stopPropagation();
    }
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–π—Å?')) {
        await deleteOrderFromDB(orderId);
        orders = orders.filter(o => o.id !== orderId);
        renderAll();
    }
}

function findPriceColumn(headers) {
    for (let i = 0; i < headers.length; i++) {
        const headerStr = String(headers[i]).toLowerCase();
        if (headerStr.includes('—Ü–µ–Ω–∞') || headerStr.includes('price') || headerStr.includes('0.')) {
            return i;
        }
    }
    return -1;
}

function isHeaderRow(row, headers) {
    if (!row.data || row.data.length === 0) return false;
    
    for (let i = 0; i < Math.min(3, row.data.length); i++) {
        const cellValue = String(row.data[i] || '').toLowerCase().trim();
        const headerValue = String(headers[i] || '').toLowerCase().trim();
        
        if (cellValue === headerValue || 
            cellValue === '‚Ññ' || 
            cellValue === '—Ñ–∏–æ' || 
            cellValue === '–∂–∞–º–∏') {
            return true;
        }
    }
    return false;
}

function isDateInRange(paymentDate) {
    if (!dateFilterFrom && !dateFilterTo) return true;
    if (!paymentDate) return false;

    const dateParts = paymentDate.split(' ')[0].split('.');
    const dateObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);

    if (dateFilterFrom && dateFilterTo) {
        const fromDate = new Date(dateFilterFrom);
        const toDate = new Date(dateFilterTo);
        return dateObj >= fromDate && dateObj <= toDate;
    } else if (dateFilterFrom) {
        const fromDate = new Date(dateFilterFrom);
        return dateObj >= fromDate;
    } else if (dateFilterTo) {
        const toDate = new Date(dateFilterTo);
        return dateObj <= toDate;
    }
    return true;
}

function calculateTotals() {
    let totalAll = 0;
    let totalPaid = 0;
    let totalUnpaid = 0;
    let totalSom = 0;
    let totalSomPaid = 0;
    let totalSomUnpaid = 0;
    let employeeDebts = {};
    
    orders.forEach(order => {
        const headers = order.data[0];
        order.data.forEach((row, idx) => {
            if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
                if (isHeaderRow(row, headers)) return;
                
                if (currentFilter === 'all' || 
                    (currentFilter === 'paid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') || 
                    (currentFilter === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ')) {
                    if (!employeeFilter || row.employee === employeeFilter) {
                        if (isDateInRange(row.paymentDate)) {
                            const sumDollar = parseFloat(row.data[11]) || 0;
                            const yulKira = parseFloat(row.data[12]) || 0;
                            const totalSum = sumDollar + yulKira;
                            const som = calculateSom(sumDollar, yulKira);
                            
                            totalAll += totalSum;
                            totalSom += som;
                            
                            if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                                totalPaid += totalSum;
                                totalSomPaid += som;
                            } else {
                                totalUnpaid += totalSum;
                                totalSomUnpaid += som;
                                
                                if (row.employee) {
                                    if (!employeeDebts[row.employee]) {
                                        employeeDebts[row.employee] = 0;
                                    }
                                    employeeDebts[row.employee] += totalSum;
                                }
                            }
                        }
                    }
                }
            }
        });
    });
    
    displayTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid, employeeDebts);
}

function calculateMainTotals() {
    let totalAll = 0;
    let totalPaid = 0;
    let totalUnpaid = 0;
    let totalSom = 0;
    let totalSomPaid = 0;
    let totalSomUnpaid = 0;
    
    orders.forEach(order => {
        const headers = order.data[0];
        order.data.forEach((row, idx) => {
            if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
                if (isHeaderRow(row, headers)) return;
                
                if (mainFilter === 'all' || 
                    (mainFilter === 'paid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') || 
                    (mainFilter === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ')) {
                    
                    const sumDollar = parseFloat(row.data[11]) || 0;
                    const yulKira = parseFloat(row.data[12]) || 0;
                    const totalSum = sumDollar + yulKira;
                    const som = calculateSom(sumDollar, yulKira);
                    
                    totalAll += totalSum;
                    totalSom += som;
                    
                    if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                        totalPaid += totalSum;
                        totalSomPaid += som;
                    } else {
                        totalUnpaid += totalSum;
                        totalSomUnpaid += som;
                    }
                }
            }
        });
    });
    
    displayMainTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid);
}

function calculateModalTotals() {
    if (!currentOrder) return { totalAll: 0, totalPaid: 0, totalUnpaid: 0, totalSom: 0, totalSomPaid: 0, totalSomUnpaid: 0 };
    
    let totalAll = 0;
    let totalPaid = 0;
    let totalUnpaid = 0;
    let totalSom = 0;
    let totalSomPaid = 0;
    let totalSomUnpaid = 0;
    
    const headers = currentOrder.data[0];
    currentOrder.data.forEach((row, idx) => {
        if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
            if (isHeaderRow(row, headers)) return;
            
            if (modalFilter === 'all' || 
                (modalFilter === 'paid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') || 
                (modalFilter === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ')) {
                
                const sumDollar = parseFloat(row.data[11]) || 0;
                const yulKira = parseFloat(row.data[12]) || 0;
                const totalSum = sumDollar + yulKira;
                const som = calculateSom(sumDollar, yulKira);
                
                totalAll += totalSum;
                totalSom += som;
                
                if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                    totalPaid += totalSum;
                    totalSomPaid += som;
                } else {
                    totalUnpaid += totalSum;
                    totalSomUnpaid += som;
                }
            }
        }
    });
    
    return { totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid };
}

function displayMainTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid) {
    const container = document.getElementById('mainTotalsSummary');
    
    if (orders.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    let html = `
        <h3 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">üìä –û–±—â–∏–µ —Å—É–º–º—ã</h3>
        <div class="totals-grid">
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ ($)</div>
                <div class="total-card-value total-all">${totalAll.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-paid">${totalPaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-unpaid">${totalUnpaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ (—Å–æ–º)</div>
                <div class="total-card-value total-som">${totalSom.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-paid">${totalSomPaid.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-unpaid">${totalSomUnpaid.toLocaleString()} —Å</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function displayModalTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid) {
    const container = document.getElementById('modalTotalsSummary');
    
    let html = `
        <h3 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">üìä –ò—Ç–æ–≥–∏ –ø–æ —Ä–µ–π—Å—É</h3>
        <div class="totals-grid">
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ ($)</div>
                <div class="total-card-value total-all">${totalAll.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-paid">${totalPaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-unpaid">${totalUnpaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ (—Å–æ–º)</div>
                <div class="total-card-value total-som">${totalSom.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-paid">${totalSomPaid.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-unpaid">${totalSomUnpaid.toLocaleString()} —Å</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function displayTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid, employeeDebts) {
    const container = document.getElementById('totalsSummary');
    
    let html = `
        <h3 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">üìä –ò—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã</h3>
        <div class="totals-grid">
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ ($)</div>
                <div class="total-card-value total-all">${totalAll.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-paid">${totalPaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-unpaid">${totalUnpaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ (—Å–æ–º)</div>
                <div class="total-card-value total-som">${totalSom.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-paid">${totalSomPaid.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-unpaid">${totalSomUnpaid.toLocaleString()} —Å</div>
            </div>
        </div>
    `;
    
    if (Object.keys(employeeDebts).length > 0) {
        html += '<div class="employee-debts"><h4 style="margin-bottom: 10px; color: #2c3e50;">üí∞ –î–æ–ª–≥–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (–≤ –¥–æ–ª–ª–∞—Ä–∞—Ö):</h4>';
        for (let employee in employeeDebts) {
            html += `
                <div class="employee-debt-item">
                    <span class="employee-name">${employee}</span>
                    <span class="employee-debt">${employeeDebts[employee].toFixed(2)} $</span>
                </div>
            `;
        }
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function renderAll() {
    renderOrderCards();
    renderDatabase();
    calculateTotals();
    calculateMainTotals();
}

function renderOrderCards() {
    const grid = document.getElementById('ordersGrid');
    grid.innerHTML = '';

    const uniqueOrders = new Map();
    
    orders.forEach(order => {
        const key = order.id || `${order.fileName}_${order.uploadDate}_${order.userEmail}`;
        
        if (!uniqueOrders.has(key)) {
            uniqueOrders.set(key, order);
        }
    });
    
    uniqueOrders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const paidCount = dataRows.filter(r => r.status === '–æ–ø–ª–∞—á–µ–Ω–æ').length;
        const unpaidCount = dataRows.length - paidCount;
        
        if (mainFilter === 'paid' && paidCount === 0) return;
        if (mainFilter === 'unpaid' && unpaidCount === 0) return;
        
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
            <div class="order-card-content" onclick="showOrderDetails(orders.find(o => o.id === '${order.id}'))">
                <div class="order-icon">üì¶</div>
                <div class="order-title">${formatFlightName(order.fileName)}</div>
                <div class="order-info">üìÖ ${order.uploadDate}</div>
                <div class="order-info">üìä ${dataRows.length} –∑–∞–ø–∏—Å–µ–π</div>
                <div class="order-info" style="color: #27ae60; font-weight: 600;">‚úÖ ${paidCount}</div>
                <div class="order-info" style="color: #e74c3c; font-weight: 600;">‚ùå ${unpaidCount}</div>
            </div>
            <div class="order-actions">
                <button class="btn btn-delete" onclick="deleteOrder('${order.id}', event)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

function setMainFilter(filter) {
    mainFilter = filter;
    const btns = document.querySelectorAll('.filters .filter-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderOrderCards();
    calculateMainTotals();
}

function setFilter(filter) {
    currentFilter = filter;
    const btns = document.querySelectorAll('#databaseTab .filter-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderAll();
}

function setModalFilter(filter) {
    modalFilter = filter;
    const btns = document.querySelectorAll('#modal .filter-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    showOrderDetails(currentOrder);
}

function filterByEmployee() {
    employeeFilter = document.getElementById('employeeFilter').value;
    renderAll();
}

function filterByDate() {
    dateFilterFrom = document.getElementById('dateFilterFrom').value;
    dateFilterTo = document.getElementById('dateFilterTo').value;
    renderAll();
}

function clearDateFilter() {
    document.getElementById('dateFilterFrom').value = '';
    document.getElementById('dateFilterTo').value = '';
    dateFilterFrom = '';
    dateFilterTo = '';
    renderAll();
}

function printInvoice(orderId, rowId) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;
    
    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;
    
    const sumDollar = parseFloat(row.data[11]) || 0;
    const yulKira = parseFloat(row.data[12]) || 0;
    const totalSom = calculateSom(sumDollar, yulKira);
    
    const invoiceHTML = `
        <div class="print-invoice">
            <div class="print-invoice-header">
                –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ö–ª–∏–µ–Ω—Ç–∞: ${row.data[1] || ''}
            </div>
            <table class="print-invoice-table">
                <thead>
                    <tr>
                        <th>–†–µ–π—Å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–£–ø–∞–∫</th>
                        <th>–ö–ì</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–°—É–º–º–∞$</th>
                        <th>–ô—É–ª –∫–∏—Ä–∞$</th>
                        <th>–°–æ–º</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                       <td>${formatFlightName(order.fileName)}</td>
                        <td>${row.data[4] || ''}</td>
                        <td>${row.data[5] || ''}</td>
                        <td>${row.data[6] || ''}</td>
                        <td>${row.data[7] || ''}</td>
                        <td>${row.data[9] || ''}</td>
                        <td>${row.data[10] || ''}</td>
                        <td>${sumDollar.toFixed(2)}</td>
                        <td>${yulKira.toFixed(2)}</td>
                        <td>${totalSom.toLocaleString()}</td>
                    </tr>
                    <tr><td colspan="10" style="height: 35px;"></td></tr>
                    <tr><td colspan="10" style="height: 35px;"></td></tr>
                    <tr><td colspan="10" style="height: 35px;"></td></tr>
                </tbody>
            </table>
            <div class="print-invoice-footer">
                <div>–ü–æ–¥–ø–∏—Å—å –ü–æ–ª—É—á–∞—Ç–µ–ª—è –¥–µ–Ω–µ–≥: _________________</div>
                <div>–ü–æ–¥–ø–∏—Å—å –ü–æ–ª—É—á–∞—Ç–µ–ª—è –¢–æ–≤–∞—Ä–∞: _________________</div>
            </div>
        </div>
    `;
    
    const printArea = document.getElementById('invoicePrintArea');
    // –î–í–ï –ö–û–ü–ò–ò –ë–ï–ó –†–ê–ó–î–ï–õ–ò–¢–ï–õ–Ø - –ù–ê –û–î–ù–û–ú –õ–ò–°–¢–ï!
    printArea.innerHTML = invoiceHTML + invoiceHTML;
    
    window.print();
    
    setTimeout(() => {
        printArea.innerHTML = '';
    }, 1000);
}
// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –í–°–ï–• –ó–ê–ö–ê–ó–û–í –í EXCEL
window.downloadAllOrders = function() {
    if (orders.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const exportData = [];

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
        '–†–µ–π—Å', '‚Ññ', '–§–ò–û', '–ì–æ—Ä–æ–¥', '–≥/–ø', '–¢–µ–ª–µ—Ñ–æ–Ω',
        '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ú–µ—Å—Ç–æ', '–£–ø–∞–∫', '—à—Ç', '–∫–≥',
        '–¶–µ–Ω–∞$', '–°—É–º–º–∞$', '–ô—É–ª –∫–∏—Ä–∞$', '–°–æ–º',
        '–°—Ç–∞—Ç—É—Å', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', '–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã'
    ];
    exportData.push(headers);

    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const orderHeaders = order.data[0];

        dataRows.forEach(row => {
            if (isHeaderRow(row, orderHeaders)) return;

            if (!row.data || !row.data.some(cell => cell && String(cell).trim() !== '')) return;

            if (mainFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (mainFilter === 'unpaid' && row.status !== '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') return;

            // –ì–ê–†–ê–ù–¢–ò–Ø: –≤—Å–µ–≥–¥–∞ –º–∏–Ω–∏–º—É–º 13 —è—á–µ–µ–∫
            const rowData = [...row.data];
            while (rowData.length < 13) rowData.push("");

            const sumDollar = parseFloat(rowData[11]) || 0;
            const yulKira = parseFloat(rowData[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);

            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;

            const exportRow = [
                formatFlightName(order.fileName),
                rowData[0], rowData[1], rowData[2], rowData[3], rowData[4],
                rowData[5], rowData[6], rowData[7], rowData[9], rowData[10],
                rowData[11], rowData[11], rowData[12], som,
                row.status || '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ',
                row.employee || '',
                row.paymentDate || '-'
            ];

            exportData.push(exportRow);
        });
    });

    // –ò—Ç–æ–≥–∏
    const totalRow = [
        '–ò–¢–û–ì–û:', '', '', '', '', '', '', '', '', '', '', '',
        totalSumDollar.toFixed(2),
        totalYulKira.toFixed(2),
        totalSom.toLocaleString(),
        '', '', ''
    ];
    exportData.push(totalRow);

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞ Excel
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–í—Å–µ —Ä–µ–π—Å—ã');
    
    const date = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
    XLSX.writeFile(wb, `–í—Å–µ_—Ä–µ–π—Å—ã_${date}.xlsx`);
}

// –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• –í EXCEL
window.downloadDatabase = function() {
    if (orders.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const exportData = [];

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
        '–†–µ–π—Å', '‚Ññ', '–§–ò–û', '–ì–æ—Ä–æ–¥', '–≥/–ø', '–¢–µ–ª–µ—Ñ–æ–Ω',
        '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ú–µ—Å—Ç–æ', '–£–ø–∞–∫', '—à—Ç', '–∫–≥',
        '–¶–µ–Ω–∞$', '–°—É–º–º–∞$', '–ô—É–ª –∫–∏—Ä–∞$', '–°–æ–º',
        '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã'
    ];
    exportData.push(headers);

    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const orderHeaders = order.data[0];

        dataRows.forEach(row => {
            if (isHeaderRow(row, orderHeaders)) return;

            if (!row.data || !row.data.some(cell => cell && String(cell).trim() !== '')) return;

            if (currentFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (currentFilter === 'unpaid' && row.status !== '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (employeeFilter && row.employee !== employeeFilter) return;
            if (!isDateInRange(row.paymentDate)) return;

            // –ì–ê–†–ê–ù–¢–ò–Ø: –≤—Å–µ–≥–¥–∞ –º–∏–Ω–∏–º—É–º 13 —è—á–µ–µ–∫
            const rowData = [...row.data];
            while (rowData.length < 13) rowData.push("");

            const sumDollar = parseFloat(rowData[11]) || 0;
            const yulKira = parseFloat(rowData[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);

            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;

            const exportRow = [
                formatFlightName(order.fileName),
                rowData[0], rowData[1], rowData[2], rowData[3], rowData[4],
                rowData[5], rowData[6], rowData[7], rowData[9], rowData[10],
                rowData[11], rowData[11], rowData[12], som,
                row.employee || '',
                row.status || '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ',
                row.paymentDate || '-'
            ];

            exportData.push(exportRow);
        });
    });

    // –ò—Ç–æ–≥–∏
    const totalRow = [
        '–ò–¢–û–ì–û:', '', '', '', '', '', '', '', '', '', '', '',
        totalSumDollar.toFixed(2),
        totalYulKira.toFixed(2),
        totalSom.toLocaleString(),
        '', '', ''
    ];
    exportData.push(totalRow);

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞ Excel
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö');
    
    const date = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
    XLSX.writeFile(wb, `–ë–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö_${date}.xlsx`);
}

// –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù–ù–´–• –î–ê–ù–ù–´–• –í WHATSAPP/TELEGRAM
window.shareFilteredData = async function(app) {
    if (orders.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
        return;
    }

    // –°–æ–∑–¥–∞–µ–º —Å–≤–æ–¥–∫—É –¥–∞–Ω–Ω—ã—Ö
    let summaryText = `üìä –û—Ç—á–µ—Ç –ø–æ —Ä–µ–π—Å–∞–º\n`;
    summaryText += `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n`;
    summaryText += `üìã –§–∏–ª—å—Ç—Ä: ${currentFilter === 'all' ? '–í—Å–µ' : currentFilter === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}\n`;
    
    if (employeeFilter) {
        summaryText += `üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${employeeFilter}\n`;
    }
    
    if (dateFilterFrom || dateFilterTo) {
        summaryText += `üìÖ –ü–µ—Ä–∏–æ–¥: ${dateFilterFrom || '...'} - ${dateFilterTo || '...'}\n`;
    }
    
    summaryText += `\nüì¶ –í—Å–µ–≥–æ —Ä–µ–π—Å–æ–≤: ${orders.length}\n`;
    
    let totalRecords = 0;
    let paidRecords = 0;
    let unpaidRecords = 0;
    let totalSumDollar = 0;
    let totalYulKira = 0;
    
    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const orderHeaders = order.data[0];
        
        dataRows.forEach(row => {
            if (isHeaderRow(row, orderHeaders)) return;
            if (!row.data || !row.data.some(cell => cell && String(cell).trim() !== '')) return;
            
            if (currentFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (currentFilter === 'unpaid' && row.status !== '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (employeeFilter && row.employee !== employeeFilter) return;
            if (!isDateInRange(row.paymentDate)) return;
            
            totalRecords++;
            if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') paidRecords++;
            else unpaidRecords++;
            
            const sumDollar = parseFloat(row.data[11]) || 0;
            const yulKira = parseFloat(row.data[12]) || 0;
            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
        });
    });
    
    summaryText += `üìã –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${totalRecords}\n`;
    summaryText += `‚úÖ –û–ø–ª–∞—á–µ–Ω–æ: ${paidRecords}\n`;
    summaryText += `‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: ${unpaidRecords}\n`;
    summaryText += `üí∞ –û–±—â–∞—è —Å—É–º–º–∞: ${totalSumDollar.toFixed(2)} $\n`;
    summaryText += `üöõ –ô—É–ª –∫–∏—Ä–∞: ${totalYulKira.toFixed(2)} $\n`;
    summaryText += `üíµ –°–æ–º: ${calculateSom(totalSumDollar, totalYulKira).toLocaleString()} —Å\n`;
    
    // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —Ç–∞–±–ª–∏—Ü—ã
    try {
        const tableElement = document.getElementById('databaseTable');
        const canvas = await html2canvas(tableElement, {
            scale: 0.5,
            backgroundColor: '#ffffff'
        });
        
        const imageUrl = canvas.toDataURL('image/png');
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ blob
        const blob = await (await fetch(imageUrl)).blob();
        const file = new File([blob], '—Ä–µ–π—Å—ã.png', { type: 'image/png' });
        
        if (app === 'whatsapp') {
            // –î–ª—è WhatsApp Web API
            const phoneNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è WhatsApp (–≤ —Ñ–æ—Ä–º–∞—Ç–µ 79991234567):');
            if (phoneNumber) {
                const text = encodeURIComponent(summaryText);
                window.open(`https://web.whatsapp.com/t}`, '_blank');
                
                // –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
                alert('–°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –í—Ä—É—á–Ω—É—é –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª "—Ä–µ–π—Å—ã.png" –∫ —Å–æ–æ–±—â–µ–Ω–∏—é.');
            }
        } else if (app === 'telegram') {
            // –î–ª—è Telegram
            const telegramBotToken = '8295664698:AAELQC6gVYapki9lqWstmJ9dtDMonNMOX_E'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
            const chatId = prompt('id —á–∞—Ç–∞ –¥–ª—è –Ω–µ–≥–æ –Ω–∞–π–¥–∏—Ç–µ User Info ‚Ä¢ Get ID –≤ —Ç–µ–ª–µ–≥—Ä–∞–º –∏ —Å—Ç–∞—Ä—Ç –∏ –Ω–∞–ø–∏—à–∏—Ç–µ —ç—Ç–æ—Ç –∞–π–¥–∏ ');
            
            if (chatId) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                const textUrl = `https://api.telegram.org/bot${telegramBotToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(summaryText)}`;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ (—á–µ—Ä–µ–∑ FormData)
                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('photo', file);
                formData.append('caption', summaryText.substring(0, 1024));
                
                try {
                    await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                        method: 'POST',
                        body: formData
                    });
                    alert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram!');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ ID —á–∞—Ç–∞.');
                }
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:', error);
        // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        if (app === 'whatsapp') {
            const phoneNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è WhatsApp:');
            if (phoneNumber) {
                window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(summaryText)}`, '_blank');
            }
        } else if (app === 'telegram') {
            const chatId = prompt('6539699693:');
            if (chatId) {
                window.open(`https://t.me/share/url?url=&text=${encodeURIComponent(summaryText)}`, '_blank');
            }
        }
    }
}

// –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê
window.shareModalData = async function(app) {
    if (!currentOrder) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
        return;
    }

    let summaryText = `üìä –û—Ç—á–µ—Ç –ø–æ —Ä–µ–π—Å—É: ${formatFlightName(currentOrder.fileName)}\n`;
    summaryText += `üìÖ –î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${currentOrder.uploadDate}\n`;
    summaryText += `üìã –§–∏–ª—å—Ç—Ä: ${modalFilter === 'all' ? '–í—Å–µ' : modalFilter === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}\n\n`;
    
    const totals = calculateModalTotals();
    summaryText += `üí∞ –û–±—â–∞—è —Å—É–º–º–∞: ${totals.totalAll.toFixed(2)} $\n`;
    summaryText += `‚úÖ –û–ø–ª–∞—á–µ–Ω–æ: ${totals.totalPaid.toFixed(2)} $\n`;
    summaryText += `‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: ${totals.totalUnpaid.toFixed(2)} $\n`;
    summaryText += `üíµ –°–æ–º: ${totals.totalSom.toLocaleString()} —Å\n`;
    
    // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    try {
        const tableElement = document.querySelector('#tableWrapper table');
        if (tableElement) {
            const canvas = await html2canvas(tableElement, {
                scale: 0.5,
                backgroundColor: '#ffffff'
            });
            
            const imageUrl = canvas.toDataURL('image/png');
            const blob = await (await fetch(imageUrl)).blob();
            const file = new File([blob], `${formatFlightName(currentOrder.fileName)}.png`, { type: 'image/png' });
            
            if (app === 'whatsapp') {
                const phoneNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è WhatsApp:');
                if (phoneNumber) {
                    window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(summaryText)}`, '_blank');
                    alert('–°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –í—Ä—É—á–Ω—É—é –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª –∫ —Å–æ–æ–±—â–µ–Ω–∏—é.');
                }
            } else if (app === 'telegram') {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
                alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram: ' + summaryText);
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:', error);
        if (app === 'whatsapp') {
            const phoneNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è WhatsApp:');
            if (phoneNumber) {
                window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(summaryText)}`, '_blank');
            }
        }
    }
}

function renderDatabase() {
    const thead = document.getElementById('databaseTableHead');
    const tbody = document.getElementById('databaseTableBody');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    const headerRow = document.createElement('tr');
    headerRow.innerHTML = '<th>–†–µ–π—Å</th><th>‚Ññ</th><th>–§–ò–û</th><th>–ì–æ—Ä–æ–¥</th><th>–≥/–ø</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ù–∞–∏–º–æ–≤–∞–Ω–∏–µ</th><th>–ú–µ—Å—Ç–æ</th><th>–£–ø–∞–∫</th><th>—à—Ç</th><th>–∫–≥</th><th>–¶–µ–Ω–∞$</th><th>–°—É–º–º–∞$</th><th>–ô—É–ª –∫–∏—Ä–∞$</th><th>–°–æ–º</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th><th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>';
    thead.appendChild(headerRow);

    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const headers = order.data[0];
        
        dataRows.forEach(row => {
            if (isHeaderRow(row, headers)) return;
            
            const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
            if (!hasData) return;

            if (currentFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (currentFilter === 'unpaid' && row.status !== '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (employeeFilter && row.employee !== employeeFilter) return;
            if (!isDateInRange(row.paymentDate)) return;

            const sumDollar = parseFloat(row.data[11]) || 0;
            const yulKira = parseFloat(row.data[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);
            
            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;

            const tr = document.createElement('tr');
            
            tr.innerHTML = `<td style="font-weight: bold;">${formatFlightName(order.fileName)}</td>`;
            
            for (let i = 0; i < 13; i++) {
                const value = row.data[i] || '';
                const isEditable = i !== findPriceColumn(headers);
                if (isEditable) {
                    tr.innerHTML += `<td class="editable-cell" onclick="editCellDB('${order.id}', ${row.rowId}, ${i}, this)">${value}</td>`;
                } else {
                    tr.innerHTML += `<td>${value}</td>`;
                }
            }
            
            tr.innerHTML += `<td class="som-column">${som.toLocaleString()}</td>`;
            
            const employeeName = row.employee || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω';
            tr.innerHTML += `<td style="text-align: center; cursor: pointer; background: #e3f2fd;">
                <select onchange="updateEmployee('${order.id}', ${row.rowId}, this.value)" style="width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #667eea;" class="employee-select">
                    <option value="">–í—ã–±—Ä–∞—Ç—å</option>
                    ${EMPLOYEES.map(emp => `<option value="${emp}" ${employeeName === emp ? 'selected' : ''}>${emp}</option>`).join('')}
                </select>
            </td>`;
            
            const statusClass = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? 'status-paid' : 'status-unpaid';
            const statusText = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
            const paymentDateText = row.paymentDate || '-';
            
            tr.innerHTML += `
                <td class="status-cell ${statusClass}" onclick="toggleRowStatusFromDB('${order.id}', ${row.rowId})">${statusText}</td>
                <td style="text-align: center;">${paymentDateText}</td>
                <td style="text-align: center;">
                    <button class="btn btn-print-invoice" onclick="printInvoice('${order.id}', ${row.rowId})">üñ®Ô∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    });

    if (tbody.children.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="12" style="text-align: right; padding-right: 15px;">–ò–¢–û–ì–û:</td>
            <td style="text-align: center;"><strong>${totalSumDollar.toFixed(2)}</strong></td>
            <td style="text-align: center;"><strong>${totalYulKira.toFixed(2)}</strong></td>
            <td class="som-column" style="text-align: center;"><strong>${totalSom.toLocaleString()}</strong></td>
            <td colspan="4"></td>
        `;
        tbody.appendChild(totalRow);
    }
}

// ========================================
// –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–û–¢–†–£–î–ù–ò–ö–ê
// ========================================

window.updateEmployee = async function(orderId, rowId, value) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;

    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;
    
    row.employee = value;
    
    // ‚úÖ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
    try {
        const cleanedOrder = cleanData(order);
        cleanedOrder.lastModified = Date.now();
        
        await db.collection('orders').doc(order.id).set(cleanedOrder);
        
       
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–ª–≥–æ–≤)
        calculateTotals();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞!', '#e74c3c');
    }
};

window.updateEmployeeModal = async function(orderId, rowId, value) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;
    
    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;
    
    row.employee = value;
    
    // ‚úÖ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
    try {
        const cleanedOrder = cleanData(order);
        cleanedOrder.lastModified = Date.now();
        
        await db.collection('orders').doc(order.id).set(cleanedOrder);
        
        console.log('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω (–º–æ–¥–∞–ª–∫–∞):', value);
        showNotification('üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫: ' + value, '#3498db');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const totals = calculateModalTotals();
        displayModalTotals(totals.totalAll, totals.totalPaid, totals.totalUnpaid, 
                          totals.totalSom, totals.totalSomPaid, totals.totalSomUnpaid);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞!', '#e74c3c');
    }
};

// ========================================
// –ú–û–ñ–ù–û –£–î–ê–õ–ò–¢–¨ –≠–¢–ò –§–£–ù–ö–¶–ò–ò (–æ–Ω–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã)
// ========================================
// saveOrderSingle - –∑–∞–º–µ–Ω–µ–Ω–∞ –ø—Ä—è–º—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
// saveQueue - –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
// saveTimer - –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

window.editCellDB = async function(orderId, rowId, colIndex, cellElement) {
    const currentValue = cellElement.textContent.trim();
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = currentValue;
    
    cellElement.textContent = '';
    cellElement.appendChild(input);
    input.focus();
    input.select();
    
    async function saveEdit() {
        const newValue = input.value.trim();
        const order = orders.find(o => o.id == orderId);
        
        if (!order) {
            console.error('Order not found:', orderId);
            cellElement.textContent = currentValue;
            return;
        }
        
        const row = order.data.find(r => r.rowId === rowId);
        if (!row) {
            console.error('Row not found:', rowId);
            cellElement.textContent = currentValue;
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        row.data[colIndex] = newValue;
        
        // –ï—Å–ª–∏ –º–µ–Ω—è–µ–º –∫–≥ –∏–ª–∏ —Ü–µ–Ω—É ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É
        if (colIndex === 9 || colIndex === 10) {
            const kg = parseFloat(row.data[9]) || 0;
            const price = parseFloat(row.data[10]) || 0;
            row.data[11] = (kg * price).toFixed(2);
        }
        
        // ‚úÖ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï –í FIREBASE –ë–ï–ó –û–ß–ï–†–ï–î–ò!
        try {
            const cleanedOrder = cleanData(order);
            cleanedOrder.lastModified = Date.now();
            
            // –ü—Ä—è–º–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
            await db.collection('orders').doc(order.id).set(cleanedOrder);
            
            console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:', { orderId, rowId, colIndex, newValue });
            showNotification('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', '#27ae60');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É
            cellElement.textContent = newValue;
            
            // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –∫–≥ –∏–ª–∏ —Ü–µ–Ω—É, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –∏ —Å–æ–º
            if (colIndex === 9 || colIndex === 10) {
                const tr = cellElement.closest('tr');
                if (tr) {
                    const sumCell = tr.cells[12];
                    if (sumCell) sumCell.textContent = row.data[11];
                    
                    const yulKira = parseFloat(row.data[12]) || 0;
                    const sumDollar = parseFloat(row.data[11]) || 0;
                    const som = calculateSom(sumDollar, yulKira);
                    
                    const somCell = tr.cells[14];
                    if (somCell) somCell.textContent = som.toLocaleString();
                }
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –ë–ï–ó –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            calculateTotals();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!', '#e74c3c');
            cellElement.textContent = currentValue;
        }
    }

    input.onblur = saveEdit;
    input.onkeydown = (e) => { 
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit(); 
        }
        if (e.key === 'Escape') {
            cellElement.textContent = currentValue;
        }
    };
};

function showOrderDetails(order) {
    currentOrder = order;
    document.getElementById('modalTitle').textContent = formatFlightName(order.fileName);
    
    if (order.data.length === 0) {
        document.getElementById('tableWrapper').innerHTML = '<p style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        modal.classList.add('active');
        return;
    }

    const totals = calculateModalTotals();
    displayModalTotals(totals.totalAll, totals.totalPaid, totals.totalUnpaid, totals.totalSom, totals.totalSomPaid, totals.totalSomUnpaid);

    let tableHTML = '<table class="database-table">';
    
    const headers = order.data[0];
    const priceIdx = findPriceColumn(headers);
    
    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    order.data.forEach((row, rowIndex) => {
        if (rowIndex === 0) {
            tableHTML += '<thead><tr>';
            tableHTML += '<th>‚Ññ</th><th>–§–ò–û</th><th>–ì–æ—Ä–æ–¥</th><th>–≥/–ø</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ù–∞–∏–º–æ–≤–∞–Ω–∏–µ</th><th>–ú–µ—Å—Ç–æ</th><th>–£–ø–∞–∫</th><th>—à—Ç</th><th>–∫–≥</th><th>–¶–µ–Ω–∞$</th><th>–°—É–º–º–∞$</th><th>–ô—É–ª –∫–∏—Ä–∞$</th><th>–°–æ–º</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th><th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>';
            tableHTML += '</tr></thead><tbody>';
        } else {
            if (isHeaderRow(row, headers)) return;
            
            if (modalFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (modalFilter === 'unpaid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            
            const rowData = row.data;
            const hasData = rowData.some(cell => cell && String(cell).trim() !== '');
            if (!hasData) return;
            
            const sumDollar = parseFloat(rowData[11]) || 0;
            const yulKira = parseFloat(rowData[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);
            
            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;
            
            tableHTML += '<tr>';
            
            for (let colIndex = 0; colIndex < 13; colIndex++) {
                const value = rowData[colIndex] || '';
                if (colIndex !== priceIdx) {
                    tableHTML += `<td class="editable-cell" onclick="editCell('${order.id}', ${row.rowId}, ${colIndex}, this)">${value}</td>`;
                } else {
                    tableHTML += `<td>${value}</td>`;
                }
            }
            
            tableHTML += `<td class="som-column">${som.toLocaleString()}</td>`;
            
            const employeeName = row.employee || '';
            tableHTML += `<td style="text-align: center; background: #e3f2fd;">
                <select onchange="updateEmployeeModal('${order.id}', ${row.rowId}, this.value)" style="width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #667eea;">
                    <option value="">–í—ã–±—Ä–∞—Ç—å</option>
                    ${EMPLOYEES.map(emp => `<option value="${emp}" ${employeeName === emp ? 'selected' : ''}>${emp}</option>`).join('')}
                </select>
            </td>`;
            
            // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–†–Ø–î–û–ö: –°–ù–ê–ß–ê–õ–ê –û–ü–†–ï–î–ï–õ–Ø–ï–ú statusClass
            const statusClass = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? 'status-paid' : 'status-unpaid';
            const statusText = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
            const paymentDateText = row.paymentDate || '-';
            
            // ‚úÖ –ü–û–¢–û–ú –ò–°–ü–û–õ–¨–ó–£–ï–ú
            tableHTML += `
                <td class="status-cell ${statusClass}" onclick="toggleRowStatus('${order.id}', ${row.rowId}, event)">${statusText}</td>
                <td style="text-align: center;">${paymentDateText}</td>
                <td style="text-align: center;">
                    <button class="btn btn-print-invoice" onclick="printInvoice('${order.id}', ${row.rowId})">üñ®Ô∏è</button>
                </td>
            `;
            tableHTML += '</tr>';
        }
    });
    
    tableHTML += `
        <tr class="total-row">
            <td colspan="11" style="text-align: right; padding-right: 15px;">–ò–¢–û–ì–û:</td>
            <td style="text-align: center;"><strong>${totalSumDollar.toFixed(2)}</strong></td>
            <td style="text-align: center;"><strong>${totalYulKira.toFixed(2)}</strong></td>
            <td class="som-column" style="text-align: center;"><strong>${totalSom.toLocaleString()}</strong></td>
            <td colspan="4"></td>
        </tr>
    `;

    tableHTML += '</tbody></table>';
    document.getElementById('tableWrapper').innerHTML = tableHTML;
    modal.classList.add('active');
}

// ========================================
// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê
// ========================================

window.editCell = async function(orderId, rowId, colIndex, cellElement) {
    const currentValue = cellElement.textContent.trim();
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = currentValue;
    
    cellElement.textContent = '';
    cellElement.appendChild(input);
    input.focus();
    input.select();
    
    async function saveEdit() {
        const newValue = input.value.trim();
        const order = orders.find(o => o.id == orderId);
        
        if (!order) {
            cellElement.textContent = currentValue;
            return;
        }
        
        const row = order.data.find(r => r.rowId === rowId);
        if (!row) {
            cellElement.textContent = currentValue;
            return;
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        row.data[colIndex] = newValue;
        
        // –ï—Å–ª–∏ –º–µ–Ω—è–µ–º –∫–≥ –∏–ª–∏ —Ü–µ–Ω—É ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É
        if (colIndex === 9 || colIndex === 10) {
            const kg = parseFloat(row.data[9]) || 0;
            const price = parseFloat(row.data[10]) || 0;
            row.data[11] = (kg * price).toFixed(2);
        }
        
        // ‚úÖ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï –í FIREBASE
        try {
            const cleanedOrder = cleanData(order);
            cleanedOrder.lastModified = Date.now();
            
            await db.collection('orders').doc(order.id).set(cleanedOrder);
            
            console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–º–æ–¥–∞–ª–∫–∞):', { orderId, rowId, colIndex, newValue });
            showNotification('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', '#27ae60');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            cellElement.textContent = newValue;
            
            // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –∫–≥ –∏–ª–∏ —Ü–µ–Ω—É, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –∏ —Å–æ–º
            if (colIndex === 9 || colIndex === 10) {
                const tr = cellElement.closest('tr');
                if (tr) {
                    const sumCell = tr.cells[11];
                    if (sumCell) sumCell.textContent = row.data[11];
                    
                    const yulKira = parseFloat(row.data[12]) || 0;
                    const sumDollar = parseFloat(row.data[11]) || 0;
                    const som = calculateSom(sumDollar, yulKira);
                    
                    const somCell = tr.cells[13];
                    if (somCell) somCell.textContent = som.toLocaleString();
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const totals = calculateModalTotals();
            displayModalTotals(totals.totalAll, totals.totalPaid, totals.totalUnpaid, 
                              totals.totalSom, totals.totalSomPaid, totals.totalSomUnpaid);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!', '#e74c3c');
            cellElement.textContent = currentValue;
        }
    }
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        }
    });
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            cellElement.textContent = currentValue;
        }
    });
}


window.updateEmployeeModal = async function(orderId, rowId, value) {
    const order = orders.find(o => o.id == orderId);
    if (order) {
        const row = order.data.find(r => r.rowId === rowId);
        if (row) {
            row.employee = value;
            await saveOrder(order);
            showOrderDetails(order);
        }
    }
}

window.toggleRowStatus = async function(orderId, rowId, evt) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;
    
    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;
    
    // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
    if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
        row.status = '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
        row.paymentDate = null;
    } else {
        row.status = '–æ–ø–ª–∞—á–µ–Ω–æ';
        const now = new Date();
        row.paymentDate = now.toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }
    
    // ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û –¢–£ –Ø–ß–ï–ô–ö–£, –ü–û –ö–û–¢–û–†–û–ô –ö–õ–ò–ö–ù–£–õ–ò
    const clickedCell = evt ? evt.target : null;
    
    if (clickedCell) {
        if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
            clickedCell.className = 'status-cell status-paid';
            clickedCell.textContent = '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ';
        } else {
            clickedCell.className = 'status-cell status-unpaid';
            clickedCell.textContent = '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
        }
        
        const nextCell = clickedCell.nextElementSibling;
        if (nextCell) {
            nextCell.textContent = row.paymentDate || '-';
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º
    try {
        const cleanedOrder = cleanData(order);
        cleanedOrder.lastModified = Date.now();
        
        await db.collection('orders').doc(order.id).set(cleanedOrder);
        console.log('‚úÖ Saved (modal)');
    } catch (error) {
        console.error('‚ùå Error:', error);
    }
    
    setTimeout(() => {
        const totals = calculateModalTotals();
        displayModalTotals(totals.totalAll, totals.totalPaid, totals.totalUnpaid, 
                          totals.totalSom, totals.totalSomPaid, totals.totalSomUnpaid);
    }, 50);
};

window.toggleRowStatusFromDB = function(orderId, rowId) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;
    
    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;

    // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
    if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
        row.status = '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
        row.paymentDate = null;
    } else {
        row.status = '–æ–ø–ª–∞—á–µ–Ω–æ';
        const now = new Date();
        row.paymentDate = now.toLocaleString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    // ‚úÖ –ù–ê–•–û–î–ò–ú –Ø–ß–ï–ô–ö–£ –ü–û ID –°–¢–†–û–ö–ò
    const rowElement = document.getElementById(`row-${orderId}-${rowId}`);
    if (rowElement) {
        // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º (16-—è –∫–æ–ª–æ–Ω–∫–∞)
        const statusCell = rowElement.cells[16];
        const dateCell = rowElement.cells[17];
        
        if (statusCell) {
            if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                statusCell.className = 'status-cell status-paid';
                statusCell.textContent = '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ';
            } else {
                statusCell.className = 'status-cell status-unpaid';
                statusCell.textContent = '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
            }
        }
        
        if (dateCell) {
            dateCell.textContent = row.paymentDate || '-';
        }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
    const cleanedOrder = cleanData(order);
    cleanedOrder.lastModified = Date.now();
    
    db.collection('orders').doc(order.id).set(cleanedOrder)
        .then(() => console.log('‚úÖ Saved'))
        .catch(err => console.error('‚ùå Error:', err));

    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
    setTimeout(() => calculateTotals(), 50);
};

window.downloadCurrentOrder = function(type) {
    if (!currentOrder) return;
    
    const exportData = [];
    const headers = currentOrder.data[0];
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è Excel
    const excelHeaders = [
        '‚Ññ', '–§–ò–û', '–ì–æ—Ä–æ–¥', '–≥/–ø', '–¢–µ–ª–µ—Ñ–æ–Ω', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', 
        '–ú–µ—Å—Ç–æ', '–£–ø–∞–∫', '—à—Ç', '–∫–≥', '–¶–µ–Ω–∞$', '–°—É–º–º–∞$', '–ô—É–ª –∫–∏—Ä–∞$', 
        '–°–æ–º', '–°—Ç–∞—Ç—É—Å', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', '–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã'
    ];
    exportData.push(excelHeaders);
    
    let totalSumDollar = 0;
    let totalYulKira = 0;
    
    currentOrder.data.forEach((row, index) => {
        if (index > 0) {
            const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
            if (hasData) {
                if (type === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') {
                    const rowData = prepareRowForExport(row);
                    exportData.push(rowData);
                    totalSumDollar += parseFloat(row.data[11]) || 0;
                    totalYulKira += parseFloat(row.data[12]) || 0;
                } else if (type === 'all') {
                    const rowData = prepareRowForExport(row);
                    exportData.push(rowData);
                    totalSumDollar += parseFloat(row.data[11]) || 0;
                    totalYulKira += parseFloat(row.data[12]) || 0;
                }
            }
        }
    });
    
    // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
    const totalRow = new Array(excelHeaders.length).fill('');
    totalRow[11] = '–ò–¢–û–ì–û:';
    totalRow[12] = totalSumDollar.toFixed(2);
    totalRow[13] = totalYulKira.toFixed(2);
    totalRow[14] = calculateSom(totalSumDollar, totalYulKira).toLocaleString();
    exportData.push(totalRow);
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, type === 'unpaid' ? '–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ' : '–í—Å–µ');
    
    const suffix = type === 'unpaid' ? '_–Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ' : '_–≤—Å–µ';
    const fileName = currentOrder.fileName.replace('.xlsx', '').replace('.xls', '') + suffix + '.xlsx';
    XLSX.writeFile(wb, fileName);
}


function prepareRowForExport(row) {
    const sumDollar = parseFloat(row.data[11]) || 0;
    const yulKira = parseFloat(row.data[12]) || 0;
    const som = calculateSom(sumDollar, yulKira);
    
    return [
        row.data[0] || '',
        row.data[1] || '',
        row.data[2] || '',
        row.data[3] || '',
        row.data[4] || '',
        row.data[5] || '',
        row.data[6] || '',
        row.data[7] || '',
        row.data[9] || '',
        row.data[10] || '',
        row.data[11] || '',
        sumDollar,
        yulKira,
        som,
        row.status || '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ',
        row.employee || '',
        row.paymentDate || ''
    ];
}

window.printMain = function() {
    window.print();
}

window.printDatabase = function() {
    window.print();
}

window.printModal = function() {
    window.print();
}

window.filterDatabaseTable =function() {
    const selectedEmployee = this.value;
    
    // –í–º–µ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã –∫–∞–∂–¥—ã–π —Ä–∞–∑
    // –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ CSS –∏–ª–∏ —Å–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–æ–∫
    
    const rows = document.querySelectorAll('#flightsTable tbody tr');
    
    if (selectedEmployee === '') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
        rows.forEach(row => row.style.display = '');
    } else {
        // –ë—ã—Å—Ç—Ä–æ–µ —Å–∫—Ä—ã—Ç–∏–µ/–ø–æ–∫–∞–∑ —á–µ—Ä–µ–∑ CSS
        rows.forEach(row => {
            const responsible = row.cells[3]?.textContent || '';
            row.style.display = responsible === selectedEmployee ? '' : 'none';
        });
    }
}
window.clearDatabaseSearch = function() {
    document.getElementById('dbSearchInput').value = '';
    filterDatabaseTable();
}

window.filterModalTable = function() {
    const searchValue = document.getElementById('modalSearchInput').value.toLowerCase();
    const table = document.querySelector('#tableWrapper table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (row.classList.contains('total-row')) continue;
        
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            const cellText = cells[j].textContent.toLowerCase();
            if (cellText.includes(searchValue)) {
                found = true;
                break;
            }
        }
        
        if (found || searchValue === '') {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

window.clearModalSearch = function() {
    document.getElementById('modalSearchInput').value = '';
    filterModalTable();
}

async function renderAdminPanel() {
    document.getElementById('kgzRateInput').value = getKgzRate();
    await renderUsersTable();
    await renderUserStats();
}

window.updateKgzRate = function(value) {
    const rate = parseFloat(value);
    if (rate && rate > 0) {
        setKgzRate(rate);
        renderAll();
        alert('‚úÖ –ö—É—Ä—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ' + rate + ' —Å–æ–º');
    } else {
        alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞');
        document.getElementById('kgzRateInput').value = getKgzRate();
    }
}

async function renderUsersTable() {
    const users = await getFromStorage('users') || [];
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    users.forEach((user, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight: 600;">${user.email}</td>
            <td>
                <input type="text" value="${user.password}" 
                       onchange="updateUserPassword(${index}, this.value)"
                       style="width: 100%; padding: 5px; border: 1px solid #667eea; border-radius: 5px;">
            </td>
            <td style="text-align: center;">
                <span style="padding: 5px 15px; border-radius: 20px; font-weight: 600; 
                             background: ${user.isAdmin ? '#27ae60' : '#3498db'}; color: white;">
                    ${user.isAdmin ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                </span>
            </td>
            <td style="text-align: center;">
                ${!user.isAdmin ? `<button class="btn btn-danger" onclick="deleteUser(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : '<span style="color: #95a5a6;">–ó–∞—â–∏—â–µ–Ω–æ</span>'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function renderUserStats() {
    const users = await getFromStorage('users') || [];
    const container = document.getElementById('userStatsContainer');
    
    let statsHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
    
    for (const user of users) {
        const snapshot = await db.collection('orders')
            .where('userEmail', '==', user.email)
            .get();
        
        let totalOrders = 0;
        let totalPaid = 0;
        let totalUnpaid = 0;
        
        snapshot.forEach(doc => {
            const order = doc.data();
            totalOrders++;
            if (order.data) {
                order.data.forEach((row, idx) => {
                    if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
                        if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                            totalPaid++;
                        } else {
                            totalUnpaid++;
                        }
                    }
                });
            }
        });
        
        statsHTML += `
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">${user.isAdmin ? 'üëë' : 'üë§'} ${user.email}</h3>
                <div style="color: #7f8c8d; font-size: 0.95em;">
                    <div style="margin-bottom: 8px;">üì¶ –í—Å–µ–≥–æ —Ä–µ–π—Å–æ–≤: <strong>${totalOrders}</strong></div>
                    <div style="margin-bottom: 8px; color: #27ae60;">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ: <strong>${totalPaid}</strong></div>
                    <div style="color: #e74c3c;">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: <strong>${totalUnpaid}</strong></div>
                </div>
            </div>
        `;
    }
    
    statsHTML += '</div>';
    container.innerHTML = statsHTML;
}

window.addNewUser = async function() {
    const email = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const messageDiv = document.getElementById('addUserMessage');

    if (!email || !password) {
        messageDiv.style.color = '#e74c3c';
        messageDiv.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
    }

    const users = await getFromStorage('users') || [];
    
    if (users.find(u => u.email === email)) {
        messageDiv.style.color = '#e74c3c';
        messageDiv.textContent = '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
        return;
    }

    users.push({ email, password, isAdmin: false });
    await setToStorage('users', users);

    messageDiv.style.color = '#27ae60';
    messageDiv.textContent = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω';
    
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';

    setTimeout(() => {
        messageDiv.textContent = '';
    }, 3000);

    renderAdminPanel();
}

window.updateUserPassword = async function(index, newPassword) {
    const users = await getFromStorage('users') || [];
    if (users[index]) {
        users[index].password = newPassword;
        await setToStorage('users', users);
    }
}

window.deleteUser = async function(index) {
    const users = await getFromStorage('users') || [];
    
    if (users[index] && users[index].isAdmin) {
        alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
        return;
    }

    if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${users[index].email}?`)) {
        const userEmail = users[index].email;
        users.splice(index, 1);
        await setToStorage('users', users);
        
        const snapshot = await db.collection('orders')
            .where('userEmail', '==', userEmail)
            .get();
        
        const batch = db.batch();
        snapshot.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
        
        renderAdminPanel();
    }
}

// –ì–û–õ–û–°–û–í–û–ô –ü–û–ú–û–©–ù–ò–ö
let recognition = null;
let isListening = false;

function showNotification(text, color = '#27ae60') {
    const old = document.querySelector('.voice-notification');
    if (old) old.remove();

    const notification = document.createElement('div');
    notification.className = 'voice-notification';
    notification.style.top = '20px';
    notification.style.background = color;
    notification.textContent = text;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

function speak(text) {
    console.log('üîä', text);
    showNotification('‚úÖ ' + text);
    
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ru-RU';
        window.speechSynthesis.speak(utterance);
    }
}

window.processVoiceCommand = function(text) {
    const lower = text.toLowerCase();
    console.log('üé§ –ö–æ–º–∞–Ω–¥–∞:', text);
    showNotification('üé§ "' + text + '"', '#3498db', '100px');
    
    // –ö–æ–º–∞–Ω–¥–∞ –æ–ø–ª–∞—Ç—ã
    if (lower.match(/–æ–ø–ª–∞—Ç–∏|–æ–ø–ª–∞—Ç–∏—Ç—å|–æ–ø–ª–∞—á–µ–Ω|tul|tulov|tulandi|—Ç—û–ª–æ–≤/)) {
        const name = text.replace(/–æ–ø–ª–∞—Ç–∏|–æ–ø–ª–∞—Ç–∏—Ç—å|–æ–ø–ª–∞—á–µ–Ω|tul|tulov|tulandi|—Ç—û–ª–æ–≤|—Ä–µ–π—Å|reys|\d+/gi, '').trim();
        speak('–û–ø–ª–∞—á–∏–≤–∞—é ' + name);
        
        let count = 0;
        let toSave = [];
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        orders.forEach(order => {
            let changed = false;
            order.data.forEach((row, i) => {
                if (i > 0 && row.data) {
                    const fio = (row.data[1] || '').toLowerCase();
                    if (fio.includes(name.toLowerCase())) {
                        row.status = '–æ–ø–ª–∞—á–µ–Ω–æ';
                        row.paymentDate = new Date().toLocaleString('ru-RU', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                        count++;
                        changed = true;
                    }
                }
            });
            if (changed) toSave.push(order);
        });
        
        if (count > 0) {
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú BATCH –°–û–•–†–ê–ù–ï–ù–ò–ï –í–ú–ï–°–¢–û Promise.all
            showNotification(`üîÑ –°–æ—Ö—Ä–∞–Ω—è—é ${count} –∑–∞–ø–∏—Å–µ–π...`, '#3498db');
            saveOrdersBatch(toSave).then(() => {
                renderAll();
                speak('–û–ø–ª–∞—á–µ–Ω–æ ' + count + ' –¥–ª—è ' + name);
            });
        } else {
            speak('–ù–µ –Ω–∞–π–¥–µ–Ω ' + name);
        }
        return;
    }
    
    // –ö–æ–º–∞–Ω–¥–∞ —Å–Ω—è—Ç–∏—è –æ–ø–ª–∞—Ç—ã
    if (lower.match(/—Å–Ω–∏–º–∏|—Å–Ω—è—Ç—å|–æ—Ç–º–µ–Ω–∏|bekor|–±–µ–∫–æ—Ä/)) {
        const name = text.replace(/—Å–Ω–∏–º–∏|—Å–Ω—è—Ç—å|–æ—Ç–º–µ–Ω–∏|–æ–ø–ª–∞—Ç—É|–Ω–µ|–æ–ø–ª–∞—á–µ–Ω|bekor|–±–µ–∫–æ—Ä|—Ä–µ–π—Å|reys|\d+/gi, '').trim();
        speak('–°–Ω–∏–º–∞—é –æ–ø–ª–∞—Ç—É ' + name);
        
        let count = 0;
        let toSave = [];
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        orders.forEach(order => {
            let changed = false;
            order.data.forEach((row, i) => {
                if (i > 0 && row.data) {
                    const fio = (row.data[1] || '').toLowerCase();
                    if (fio.includes(name.toLowerCase())) {
                        row.status = '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                        row.paymentDate = null;
                        count++;
                        changed = true;
                    }
                }
            });
            if (changed) toSave.push(order);
        });
        
        if (count > 0) {
            // –ò–°–ü–û–õ–¨–ó–£–ï–ú BATCH –°–û–•–†–ê–ù–ï–ù–ò–ï –í–ú–ï–°–¢–û Promise.all  
            showNotification(`üîÑ –°–æ—Ö—Ä–∞–Ω—è—é ${count} –∑–∞–ø–∏—Å–µ–π...`, '#3498db');
            saveOrdersBatch(toSave).then(() => {
                renderAll();
                speak('–°–Ω—è—Ç–æ ' + count + ' –¥–ª—è ' + name);
            });
        } else {
            speak('–ù–µ –Ω–∞–π–¥–µ–Ω ' + name);
        }
        return;
    }
    
    if (lower.match(/–Ω–∞–∑–Ω–∞—á—å|tayinla|—Ç–∞–π–∏–Ω–ª–∞/)) {
        let emp = EMPLOYEES.find(e => lower.includes(e.toLowerCase()));
        if (!emp) { speak('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
        
        const name = text.replace(new RegExp(emp, 'gi'), '')
            .replace(/–Ω–∞–∑–Ω–∞—á—å|tayinla|—Ç–∞–π–∏–Ω–ª–∞|–¥–ª—è|—É—á—É–Ω|—Ä–µ–π—Å|reys|\d+/gi, '').trim();
        speak('–ù–∞–∑–Ω–∞—á–∞—é ' + emp);
        
        let count = 0;
        let toSave = [];
        
        orders.forEach(order => {
            let changed = false;
            order.data.forEach((row, i) => {
                if (i > 0 && row.data) {
                    const fio = (row.data[1] || '').toLowerCase();
                    if (fio.includes(name.toLowerCase())) {
                        row.employee = emp;
                        count++;
                        changed = true;
                    }
                }
            });
            if (changed) toSave.push(order);
        });
        
        if (count > 0) {
            Promise.all(toSave.map(o => saveOrder(o))).then(() => {
                renderAll();
                speak('–ù–∞–∑–Ω–∞—á–µ–Ω ' + emp);
            });
        } else {
            speak('–ù–µ –Ω–∞–π–¥–µ–Ω ' + name);
        }
        return;
    }
    
    if (lower.match(/–Ω–∞–π–¥–∏|–Ω–∞–π—Ç–∏|–ø–æ–∏—Å–∫|top|—Ç–æ–ø|qidi/)) {
        const search = text.replace(/–Ω–∞–π–¥–∏|–Ω–∞–π—Ç–∏|–ø–æ–∏—Å–∫|top|—Ç–æ–ø|qidi|–∫–∏–¥–∏/gi, '').trim();
        const input = document.getElementById('dbSearchInput') || 
                      document.getElementById('modalSearchInput');
        if (input) {
            input.value = search;
            input.dispatchEvent(new Event('input'));
            speak('–ò—â—É ' + search);
        }
        return;
    }
    
    if (lower.match(/–ø–æ–º–æ—â—å|yordam|—ë—Ä–¥–∞–º/)) {
        speak('–°–∫–∞–∂–∏—Ç–µ: –æ–ø–ª–∞—Ç–∏ –∏–º—è, —Å–Ω–∏–º–∏ –æ–ø–ª–∞—Ç—É –∏–º—è, –Ω–∞–∑–Ω–∞—á—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–º—è');
        return;
    }
    
    const input = document.getElementById('dbSearchInput') || 
                  document.getElementById('modalSearchInput');
    if (input) {
        input.value = text;
        input.dispatchEvent(new Event('input'));
        speak('–ò—â—É ' + text);
    }
};

window.startVoiceSearch = function(inputId) {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!recognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            console.log('üìù', text);
            processVoiceCommand(text);
        };
        
        recognition.onerror = (e) => {
            isListening = false;
            console.error('‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', e.error);
            
            if (e.error === 'no-speech') {
                speak('–ù–µ —É—Å–ª—ã—à–∞–ª. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
            } else if (e.error === 'not-allowed' || e.error === 'permission-denied') {
                const msg = `üî¥ –ú–ò–ö–†–û–§–û–ù –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù!\n\n–ö–ê–ö –†–ê–ó–†–ï–®–ò–¢–¨:\n\n1Ô∏è‚É£ –ù–∞–∂–º–∏ –Ω–∞ –∑–∞–º–æ—á–µ–∫ üîí —Å–ª–µ–≤–∞ –æ—Ç –∞–¥—Ä–µ—Å–∞ —Å–∞–π—Ç–∞\n2Ô∏è‚É£ –ù–∞–π–¥–∏ "–ú–∏–∫—Ä–æ—Ñ–æ–Ω"\n3Ô∏è‚É£ –í—ã–±–µ—Ä–∏ "–†–∞–∑—Ä–µ—à–∏—Ç—å"\n4Ô∏è‚É£ –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)\n5Ô∏è‚É£ –ù–∞–∂–º–∏ üé§ –ì–æ–ª–æ—Å —Å–Ω–æ–≤–∞`;
                alert(msg);
            }
            
            document.querySelectorAll('.btn-success').forEach(btn => {
                if (btn.textContent.includes('–°–ª—É—à–∞—é')) {
                    btn.textContent = 'üé§ –ì–æ–ª–æ—Å';
                    btn.style.background = '#27ae60';
                }
            });
        };
        
        recognition.onstart = () => {
            isListening = true;
            document.querySelectorAll('.btn-success').forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes('startVoiceSearch')) {
                    btn.textContent = 'üî¥ –°–ª—É—à–∞—é...';
                    btn.style.background = '#e74c3c';
                }
            });
        };
        
        recognition.onend = () => {
            isListening = false;
            document.querySelectorAll('.btn-success').forEach(btn => {
                if (btn.textContent.includes('–°–ª—É—à–∞—é')) {
                    btn.textContent = 'üé§ –ì–æ–ª–æ—Å';
                    btn.style.background = '#27ae60';
                }
            });
        };
    }
    
    try {
        if (isListening) recognition.stop();
        else recognition.start();
    } catch(e) {
        recognition.stop();
        setTimeout(() => recognition.start(), 100);
    }
};

init();
    </script>
</body>
